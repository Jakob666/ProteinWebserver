<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>test result</title>
{#    {% load static %}  https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js#}
    <script type="text/javascript" src="/static/js/jquery-3.1.1.js"></script>
    <script type="text/javascript" src="/static/js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.form.js"></script>
</head>
<body>
    <h2>Lysine TCGA</h2>
    <!----------- 这里可以换成 div ---------------->
    <div>
        <p><b>user:</b>&nbsp;&nbsp;<span style="color: darkblue" {% if user_name %}{% endif %}><b>{{ user_name }}</b></span></p>
        <p><b>submit time:</b>&nbsp;&nbsp;<span style="color: darkblue" {% if submit_time %}{% endif %}><b>{{ submit_time }}</b></span></p>
        <p><b>status:</b>&nbsp;&nbsp;<b><span id="task_status" style="color: darkblue" {% if status %}{% endif %}>{{ status }}</span></b></p>
    </div>
    <div>
        <img id="processing_img" style="height: 150px; padding-left: 80px; visibility: visible" src="/static/img/running.gif">
    </div>
    <!------------------------------------------->
    <div>
    <table id="result_table" style="visibility: hidden" border="1" {% if test_result %}{% endif %}>
    <thead>
        <tr>
            <th>Cancer Type</th>
            <th>Uniprot Accession</th>
            <th>Position</th>
            <th>Location</th>
            <th>From</th>
            <th>To</th>
            <th>TCGA Patient ID</th>
        </tr>
    </thead>
    <tbody id="table_body">
        {% for v in test_result %}
            <!---- v是列表，django的template中只能这种形式表示，一般python中索引会报错 ---->
            <tr>
                <td>{{ v.0 }}</td>
                <td>{{ v.1 }}</td>
                <td>{{ v.2 }}</td>
                <td>{{ v.3 }}</td>
                <td>{{ v.4 }}</td>
                <td>{{ v.5 }}</td>
                <td>{{ v.6 }}</td>
            </tr>
        {% endfor %}
    </tbody>
    </table>
    </div>
    <div style="padding-top: 20px">
    <table id="summary_table" style="visibility: hidden" border="1">
        <thead>
        <tr>
            <th>Uniport Accession</th>
            <th>Motif length</th>
            <th>Background length</th>
            <th>Significant</th>
            <th>FDR</th>
        </tr>
        </thead>
        <tbody id="summary_tbody"></tbody>
    </table>
    </div>
    <div id="fail_reason" style="visibility: hidden">
        <p style="padding-left: 30px;"><b></b></p>
    </div>
    <div>
        <img id="wait_loading" style="height: 230px; padding-left: 80px; visibility: hidden" src="/static/img/loading.gif">
    </div>
    <div id="visulize" {% if visulize %}{% endif %}>
        <img src="{{ visulize }}">
    </div>

</body>
<script>
     // 定义一个读取日志的方法，检测是否分析成功，成功返回true；不成功返回false
    function readLog() {
        var cook_info = document.cookie;
        cook_info = cook_info.split(";");
        var username;
        // 首先从cookie中获取用户名
        for (var i = 0; i < cook_info.length; i++) {
            var info = cook_info[i].trim().split("=");
            if (info[0] == "cname") {
                username = info[2].split('"')[0];
            }
        }
        $.ajax({
            type: "post",
            url: "/check_log/log_res/",
            dataType: "json",
            data: {"username": username},
            async: true,
            success: function (ret) {
                running_img_vanish();
                $("#task_status").text("finished");
                table_appear();
                summary_appear();
                loading_appear();
                console.log("日志查询成功");
                obj.if_check = ret.log_result;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
                console.log("日志查询失败");
                obj.if_check = false;
            }
        });
    }

    // 动态的running GIF图片消失
    function running_img_vanish() {
        $("#processing_img").css("visibility", "hidden");
        $("#processing_img").hide("slow");
    }

    // 在最终结果加载出来之前loading GIF显现
    function loading_appear(){
        $("#wait_loading").css("visibility", "visible");
    }

    // 在最终结果加载出来之前loading GIF显现
    function loading_vanish(){
        $("#wait_loading").hide("fast");
    }

    // 分析成功后现实表格并加载结果文件
    function table_appear() {
        $("#result_table").css("visibility", "visible");
    }
    function summary_appear() {
        $("#summary_table").css("visibility", "visible");
    }

    function load_analysis_result() {
        var cook_info = document.cookie;
        cook_info = cook_info.split(";");
        var username;
        // 首先从cookie中获取用户名
        for (var i = 0; i < cook_info.length; i++) {
            var info = cook_info[i].trim().split("=");
            if (info[0] == "cname") {
                username = info[2].split('"')[0];
                console.log(username);
            }
        }
        $.ajax({
            type: "post",
            url: "/get_result/load_result/",
            dataType: "json",
            data: {"username": username},
            async: false,
            success: function (ret) {
                loading_vanish();
                var row = ret.row_num;
                var data = ret.test_result;
                var summary = ret.summary;
                var detail_info = document.getElementById("table_body");
                var summary_info = document.getElementById("summary_tbody");

                // 将表格内容清空，仅留下表头
                $("#table_body").empty();
                for (var i = 0; i < row; i++){
                    var tr = document.createElement("tr");
                    for (var j = 0; j < 7; j++){
                        var td = document.createElement("td");
                        td.innerHTML = data[i][j];
                        tr.appendChild(td);
                    }
                    detail_info.appendChild(tr);
                }
                $("#result_table").append(detail_info);

                $("#summary_tbody").empty();
                for (var i = 0; i < summary.length; i++){
                    var tr = document.createElement("tr");
                    for (var j = 0; j < 5; j++){
                        var td = document.createElement("td");
                        td.innerHTML = summary[i][j];
                        tr.appendChild(td);
                    }
                    summary_info.appendChild(tr);
                }
                $("#summary_table").append(summary_info);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
                console.log("加载分析结果失败");
            }
        })
    }

    // 如果分析失败，查看日志得到失败原因
    function load_fail_result() {
        var cook_info = document.cookie;
        cook_info = cook_info.split(";");
        var username;
        // 首先从cookie中获取用户名
        for (var i = 0; i < cook_info.length; i++) {
            var info = cook_info[i].trim().split("=");
            if (info[0] == "cname") {
                username = info[2].split('"')[0];
                console.log(username);
            }
        }
        $.ajax({
            type: "post",
            url: "/get_result/load_result/",
            dataType: "json",
            data: {"username": username},
            async: false,
            success: function (ret) {
                var reason = ret.fail_reason;
                $("#fail_reason").css("visibility", "visible");
                $("#fail_reason p").text(reason);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
                console.log("加载出错日志失败");
            }
        })
    }


    var obj = {};
    obj.if_check = null;
    //用于监听if_upload的值
    Object.defineProperty(obj, 'if_check',{
        get:function(){
            return if_check;
        },
        set:function (newValue) {
            if_check = newValue;
            if (newValue){
                load_analysis_result();
            }else{
                load_fail_result();
            }
        }
    });
    var process = true;
    if (process){

        var has_result = readLog();
        // 如果返回true，说明分析成功
{#        if (has_result){#}
{#            console.log("分析成功，加载结果");#}
{#            process = false;#}
{#            load_analysis_result();#}
{#        }else{  // 如果返回false则需要检查什么原因导致预测失败#}
{#            load_fail_result();#}
{#        }#}
    }
</script>
</html>