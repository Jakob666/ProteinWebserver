<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lysine TCGA Web Server</title>
    {% load static %}
    {% load crispy_forms_tags %}
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <link rel="stylesheet" href="/static/css/bootstrap-table.css">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <script type="text/javascript" src="/static/js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.form.js"></script>
    <script type="text/javascript" src="/static/js/jquery-3.1.1.js"></script>
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/bootstrap-table.js"></script>
</head>
<body>
<div class="container">

        <div class="col-sm-9">
{#action={% url "user_upload:user_upload" %} #}
{#            {% crispy form %}#}
            <form method="post" enctype="multipart/form-data" role="form" class="form-horizontal">
                {% csrf_token %}
                {{ form.non_field_errors }}
                <div class="form-group">
                    {{ form.input_text.errors }}
                    {{ form.input_text.label_tag }}
                    {{ form.input_text }}
                    {% if input_text.error %}
                        input_text.error
                    {% endif %}
                </div>
                <div class="btn-group btn-group-lg" style="padding-left: 20px">
                    <input id="elm_example" class="btn btn-default" type="button" value="elm exmple" />
                    <input id="vcf_example" class="btn btn-default" type="button" value="vcf exmple" />
                    <input id="tab_example" class="btn btn-default" type="button" value="tab exmple" />
                    <input id="clear_all" class="btn btn-default" type="button" value="clear" />
                </div>
                <div>
                    {{ file_upload_rule }}
                </div>
                <div class="custom-file">
                    {{ form.elm_file.errors }}
                    {{ form.elm_file.label_tag }}
                    {{ form.elm_file }}
                    <p {% if elm_file_error %} {% endif %}>
                        {{ elm_file_error }}
                    </p>
                </div>
                <div>
                    {{ form.vcf_file.errors }}
                    {{ form.vcf_file.label_tag }}
                    {{ form.vcf_file }}
                    <p {% if vcf_file_error %} {% endif %}>
                        {{ vcf_file_error }}
                    </p>
                </div>
                <div>
                    {{ form.tab_file.errors }}
                    {{ form.tab_file.label_tag }}
                    {{ form.tab_file }}
                    <p {% if tab_file_error %} {% endif %}>
                        {{ tab_file_error }}
                    </p>
                    <p id="upload_error" {% if file_upload_error %} {% endif %}>
                        {{ file_upload_error }}
                    </p>
                </div>
                <div id="upload_success">
                    <p  {% if file_upload_success %} {% endif %}>
                        {{ file_upload_success }}
                    </p>
                </div>
                <div>
                    {{ form.organism.errors }}
                    {{ form.organism.label_tag }}
                    {{ form.organism }}
                </div>
                <div>
                    {{ form.modification.errors }}
                    {{ form.modification.label_tag }}
                    {{ form.modification }}
                </div>
                <div>
                    {{ form.cancer.errors }}
                    {{ form.cancer.label_tag }}
                    {{ form.cancer }}
                </div>
                <div>
                    {{ form.threshold.errors }}
                    {{ form.threshold.label_tag }}
                    {{ form.threshold }}
                </div>
                <div>
                    {{ form.email.errors }}
                    {{ form.email.label_tag }}
                    {{ form.email }}
                </div>
                <input id="upload_file" class="btn btn-primary" type="submit" value="upload file" onclick="upload()" />
            </form>
        </div>

    <!------- 如果上传成功会有提示长传成功并开始运算 ---------------->
    <div  {% if upload_success %}{% endif %}>
        {{ upload_success }}
    </div>
    <br />
    <br />
    <div class="col-sm-9">
        <table class="table table-bordered table-hover table-responsive"  {% if user_history %}{% endif %}>
            <tr class="info">
                <th class="col-sm-3">upload time</th>
                <th class="col-sm-3">task status</th>
                <th class="col-sm-3">detail</th>
            </tr>
            {% for k, v in user_history.items %}
            <tr>

                {% if v == "error" %}
                <td class="danger">{{ k }}</td>
                <td class="danger">{{ v }}</td>
                <td class="danger"><a type="button" class="btn btn-danger" href="/get_result/{{ k }}view_history{{ v }}/" target="_blank">View</a></td>
                {% endif %}
                {% if v != "error" %}
                <td>{{ k }}</td>
                <td>{{ v }}</td>
                <td><a type="button" class="btn btn-primary" href="/get_result/{{ k }}view_history{{ v }}/" target="_blank">View</a></td>
                {% endif %}
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
</body>
<script type="text/javascript">
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);

                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function csrfSafeMethod(method) {
        // 指定这些方法不需要 CSRF 保护
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
        var csrftoken = getCookie('csrftoken');
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    var obj = {};
    obj.if_upload = null;
    //用于监听if_upload的值
    Object.defineProperty(obj, 'if_upload',{
        get:function(){
            return if_upload;
        },
        set:function (newValue) {
            if_upload = newValue;
            if (!newValue){
                console.log("上传失败，没跳转页面")
            }
        }
    });

    function upload() {
        var input_text = $('#id_input_text').val();
        var elm_file = $('#id_elm_file')[0].files[0];
        var vcf_file = $('#id_vcf_file')[0].files[0];
        var tab_file = $('#id_tab_file')[0].files[0];
        var organism = $('#id_organism').val();
        var cancer = $('#id_cancer').val();
        var threshold = $('#id_threshold').val();
        var email = $('#id_email').val();
        var modification = $('#id_modification').val();

        $.ajax({
            method: "post",
            url: "/webserver/user_upload/",
            processData: false,
            data: {"input_text": input_text, "elm_file": elm_file, "vcf_file": vcf_file,
                   "tab_file": tab_file, "modification": modification, "cancer": cancer,
                   "threshold": threshold, "email": email, "organism": organism
            },
            async: true,
            success: function () {
              console.log("上传完成");
              obj.if_upload = true;
            },
            error:function (r1) {
                // 请求失败，if_upload变量的值为false
                obj.if_upload = false;
            }
        });
    }


    $("#elm_example").click(function () {
        $("#id_input_text").val("");
        showExample($("#elm_example").val());
    });
    $("#vcf_example").click(function () {
        $("#id_input_text").val("");
        showExample($("#vcf_example").val())
    });
    $("#tab_example").click(function () {
        $("#id_input_text").val("");
        showExample($("#tab_example").val())
    });
    $("#clear_all").click(function () {
        $("#id_input_text").val("");
    });

    function showExample(exampleType) {
        $.ajax({
            type: "post",
            url: "/get_example/",
            data: {"exampleType": exampleType},
            asyns: false,
            success: function (ret) {
                $("#id_input_text").val(ret);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status);
                console.log(XMLHttpRequest.readyState);
                console.log(textStatus);
                console.log(errorThrown);
                console.log("样例文件导出失败");
            }
        });
    }

    



</script>
</html>